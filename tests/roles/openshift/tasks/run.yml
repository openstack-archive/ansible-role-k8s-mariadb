---
- name: Set various Docker options
  lineinfile:
    dest: /etc/sysconfig/docker
    regexp: '^OPTIONS=.*$'
    line: "OPTIONS='\
      --log-driver=journald \
      --signature-verification=false \
      --insecure-registry 172.30.0.0/16"

- name: Set various Docker options
  lineinfile:
    dest: /etc/sysconfig/docker-storage-setup
    regexp: '^STORAGE_DRIVER=.*$'
    line: "STORAGE_DRIVER=overlay2"

- name: restart docker
  systemd:
    name: "docker"
    state: restarted
  register: docker_restart_docker_result
  until: not docker_restart_docker_result | failed
  retries: 3
  delay: 30

- shell:
    cmd: |
      set -e
      set -x

      oc cluster up --version=v3.6.1
      oc login -u system:admin
      oc delete scc anyuid hostaccess hostmount-anyuid hostnetwork privileged nonroot restricted

      cat <<EOF | oc create -f -
      kind: SecurityContextConstraints
      apiVersion: v1
      metadata:
        name: permissive
      allowHostDirVolumePlugin: true
      allowHostIPC: true
      allowHostNetwork: true
      allowHostPID: true
      allowHostPorts: true
      allowPrivilegedContainer: true
      allowedCapabilities:
        - '*'
      runAsUser:
        type: RunAsAny
      seLinuxContext:
        type: RunAsAny
      groups:
        - system:authenticated
      defaultAddCapabilities: []
      fsGroup:
        type: RunAsAny
      EOF

      sudo mkdir /tmp/test-volume

      cat <<EOF | oc create -f -
      apiVersion: v1
      kind: PersistentVolume
      metadata:
        name: openstack-test-volume
      spec:
        capacity:
          storage: 5Gi
        accessModes:
          - ReadWriteMany
        persistentVolumeReclaimPolicy: Recycle
        storageClassName: slow
        hostPath:
          path: /tmp/test-volume
      EOF

      sudo chown zuul:zuul -R /tmp/test-volume
      sudo chmod 777 /tmp/test-volume

    executable: /bin/bash
  become: true
  delegate_to: "primary"
  environment: '{{ zuul | zuul_legacy_vars }}'
  register: oc_output

- name: Login to OpenShift
  shell:
    cmd: |
      set -e
      set -x

      oc login https://127.0.0.1:8443 --insecure-skip-tls-verify=true -u developer -p developer
      oc new-project openstack
    executable: /bin/bash
  delegate_to: "primary"
  environment: '{{ zuul | zuul_legacy_vars }}'
