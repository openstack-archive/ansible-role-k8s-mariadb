---
- name: Add ASB repo for ansible-kubernetes-modules
  become: true
  yum_repository:
    name: asb
    description: Copr repo for ansible-service-broker-latest owned by @ansible-service-broker
    file: asb
    baseurl: https://copr-be.cloud.fedoraproject.org/results/@ansible-service-broker/ansible-service-broker-latest/epel-7-$basearch/
    gpgkey: https://copr-be.cloud.fedoraproject.org/results/@ansible-service-broker/ansible-service-broker-latest/pubkey.gpg
    gpgcheck: true
    enabled: true
    skip_if_unavailable: true
    repo_gpgcheck: false

- name: Enable/Install centos-release-openshift-origin
  become: true
  yum:
    name: "{{item}}"
    state: present
  with_items:
    - centos-release-openshift-origin

# NOTE(flaper87): python-openshift requires a specific version of
# python-requests. We need to update it to the version in the asb repo, hence
# this step. We have to enable epel so we can meet the python2-pysocks
# dependency, which is a python-requests requirement.
- name: Force update for requests/urllib3
  become: true
  yum:
    name: "{{item}}"
    state: latest
    update_cache: true
    enablerepo: asb,epel
    disablerepo: delorean
  with_items:
    - python-requests

- name: Install required packages
  become: true
  yum:
    name: "{{item}}"
    state: latest
  with_items:
    - ansible
    - python-netaddr
    - origin-clients
    - docker
    - docker-distribution

- name: Install required packages from asb
  become: true
  yum:
    name: "{{item}}"
    state: latest
  with_items:
    - ansible-kubernetes-modules

- name: Set docker registry options for OpenShift
  become: true
  lineinfile:
    dest: /etc/sysconfig/docker
    regexp: '^OPTIONS=.*$'
    line: "OPTIONS='\
      --log-driver=journald \
      --signature-verification=false \
      --insecure-registry 172.30.0.0/16"

- name: Set Docker storage options
  become: true
  lineinfile:
    dest: /etc/sysconfig/docker-storage-setup
    regexp: '^STORAGE_DRIVER=.*$'
    line: "STORAGE_DRIVER=overlay2"

- name: Start docker
  become: true
  service:
    name: docker
    state: restarted
