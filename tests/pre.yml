---
- hosts: all
  vars:
    logs_dir: "/tmp/logs"
  tasks:
    - name: "Ensure {{item}} dir exists"
      file:
        path: "{{item}}"
        state: "directory"
      with_items:
        - "{{ logs_dir }}"

    - name: Ensure node directories
      file:
        path: "{{ logs_dir }}/{{ item }}"
        state: "directory"
        mode: 0777
      with_items:
        - "logs"
        - "logs/containers"

    - name: "iptables: don't jump straight to openstack-INPUT"
      become: true
      iptables:
        chain: "INPUT"
        jump: "openstack-INPUT"
        state: absent

    - include: pre_rhel.yml
      when: ansible_os_family == 'RedHat'

    - include: pre_debian.yml
      when: ansible_os_family == 'Debian'

    - include: 'roles/{{coe}}/tasks/pre.yml'

    - name: Create symlink for all required projects
      become: true
      file:
        src: "{{ ansible_env.HOME }}/{{ item.value.src_dir }}"
        dest: "/etc/ansible/roles/{{ item.value.short_name }}"
        state: link
      delegate_to: primary
      with_dict: "{{zuul.projects}}"
